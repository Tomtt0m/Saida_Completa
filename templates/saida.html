<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Saída Completa</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <div class="container" style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
    <h1>Saída Completa</h1>
    <p>Olá, <strong>{{ usuario }}</strong></p>

    <button id="start-scan">Registrar Palete Completo</button>

    <div id="qr-reader" class="qr-code-container" style="display: none; width: 300px;"></div>

    <form id="form-dados" style="display: none;" enctype="multipart/form-data">
      <input type="hidden" name="registro_id" id="registro_id">

      <label>QR Code:</label>
      <input type="text" id="qr_code_raw" disabled>

      <label>Cliente:</label>
      <input type="text" id="cliente" disabled>

      <label>Produto:</label>
      <input type="text" id="produto" disabled>

      <label>Rota:</label>
      <input type="text" id="rota" disabled>

      <label>Pré-nota:</label>
      <input type="text" id="pre_nota" disabled>

      <label>Região:</label>
      <input type="text" id="regiao_nome" disabled>

      <label>Nº da Caixa:</label>
      <input type="text" id="numero_caixa" disabled>

      <label for="quantidade">Quantidade de Volumes:</label>
      <input type="number" id="quantidade" required>

      <label>Anexar foto da Etiqueta:</label>
      <input type="file" id="foto_etiqueta" accept="image/*" capture="environment">
      <img id="preview_etiqueta" class="preview" style="display:none; max-width: 300px;">

      <label>Anexar foto do Palete:</label>
      <input type="file" id="foto_palete" accept="image/*" capture="environment">
      <img id="preview_palete" class="preview" style="display:none; max-width: 300px;">

      <button type="button" id="confirmar">Confirmar</button>
    </form>
  </div>

  <script>
    const startScanBtn = document.getElementById("start-scan");
    const qrReader = document.getElementById("qr-reader");
    const formDados = document.getElementById("form-dados");

    const previewEtiqueta = document.getElementById("preview_etiqueta");
    const previewPalete = document.getElementById("preview_palete");

    let scanner;
    let idSaida = null;

    startScanBtn.addEventListener("click", () => {
      qrReader.style.display = "block";
      scanner = new Html5Qrcode("qr-reader");

      scanner.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: 250
        },
        qrCodeMessage => {
          scanner.stop();
          qrReader.style.display = "none";
          processarQRCode(qrCodeMessage);
        },
        errorMessage => {
          console.log("Erro leitura:", errorMessage);
        }
      );
    });

   function extrairDadosQRCode(codigo) {
  if (codigo.length !== 46) {
    alert("QR Code inválido: deve ter 46 caracteres.");
    throw new Error("QR Code inválido: deve ter 46 caracteres.");
  }

  const rota = codigo.substring(11, 15);
  const pre_nota = codigo.substring(15, 21);
  const codigo_regiao = codigo.substring(24, 26);
  const numero_caixa = codigo.substring(42, 46);

  return {
    rota,
    pre_nota,
    codigo_regiao,
    regiao_nome: codigo_regiao === "18" ? "E DIRETA" : "DESCONHECIDA",
    cliente: "707 AUTO – SERVIÇO DE ALIMENTOS",
    produto: "CO PANTENE 510ML BIOTINAMINA B3",
    numero_caixa,
  };
}

function processarQRCode(codigo) {
  let dados;
  try {
    dados = extrairDadosQRCode(codigo);
  } catch (error) {
    alert(error.message);
    return;
  }

  dados.qr_code = codigo; // adiciona o código bruto no objeto

  fetch("/registrar", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(dados)
  })
  .then(res => res.json())
  .then(data => {
    idSaida = data.id;
    document.getElementById("registro_id").value = data.id;
    document.getElementById("qr_code_raw").value = dados.qr_code;
    document.getElementById("cliente").value = dados.cliente;
    document.getElementById("produto").value = dados.produto;
    document.getElementById("rota").value = dados.rota;
    document.getElementById("pre_nota").value = dados.pre_nota;
    document.getElementById("regiao_nome").value = dados.regiao_nome;
    document.getElementById("numero_caixa").value = dados.numero_caixa;

    formDados.style.display = "block";
  })
  .catch(err => {
    alert("Erro ao registrar dados: " + err.message);
  });
}


      fetch("/registrar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(dados)
      })
      .then(res => res.json())
      .then(data => {
        idSaida = data.id;
        document.getElementById("registro_id").value = data.id;
        document.getElementById("qr_code_raw").value = dados.qr_code;
        document.getElementById("cliente").value = dados.cliente;
        document.getElementById("produto").value = dados.produto;
        document.getElementById("rota").value = dados.rota;
        document.getElementById("pre_nota").value = dados.pre_nota;
        document.getElementById("regiao_nome").value = dados.regiao_nome;
        document.getElementById("numero_caixa").value = dados.numero_caixa;

        formDados.style.display = "block";
      });
    }

    document.getElementById("foto_etiqueta").addEventListener("change", (e) => {
      previewEtiqueta.src = URL.createObjectURL(e.target.files[0]);
      previewEtiqueta.style.display = "block";
    });

    document.getElementById("foto_palete").addEventListener("change", (e) => {
      previewPalete.src = URL.createObjectURL(e.target.files[0]);
      previewPalete.style.display = "block";
    });

    document.getElementById("confirmar").addEventListener("click", () => {
      const formData = new FormData();
      const id = document.getElementById("registro_id").value;
      formData.append("etiqueta", document.getElementById("foto_etiqueta").files[0]);
      formData.append("palete", document.getElementById("foto_palete").files[0]);

      const qtd = document.getElementById('quantidade').value;
      if (!qtd || qtd <= 0) {
        alert("Informe a quantidade de volumes.");
        return;
      }

      fetch(`/volumes/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ quantidade: qtd })
      })
      .then(() => {
        return fetch(`/upload/${id}`, { method: "POST", body: formData });
      })
      .then(() => {
        return fetch(`/confirmar/${id}`, { method: "POST" });
      })
      .then(() => {
        window.location.href = `/resumo/${id}`;
      });
    });
  </script>
</body>
</html>



